<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - UMak ECP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5aa0 50%, #1e3a5f 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.98);
            box-shadow: 4px 0 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
        }
        
        .sidebar-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5aa0 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><defs><pattern id="grain" width="100" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grain)"/></svg>');
            opacity: 0.1;
        }
        
        .sidebar-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .user-info {
            padding: 20px;
            background: #f8fafe;
            border-bottom: 2px solid #e8f0f8;
        }
        
        .user-info h3 {
            color: #1e3a5f;
            font-size: 1.1rem;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .user-info p {
            color: #666;
            font-size: 0.85rem;
            margin: 3px 0;
        }
        
        .nav-menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .nav-item {
            padding: 15px 25px;
            color: #1e3a5f;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
            cursor: pointer;
        }
        
        .nav-item:hover {
            background: rgba(44, 90, 160, 0.08);
            border-left-color: #2c5aa0;
            transform: translateX(5px);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(44, 90, 160, 0.15) 0%, rgba(44, 90, 160, 0.05) 100%);
            border-left-color: #2c5aa0;
            color: #2c5aa0;
        }
        
        .nav-item-icon {
            font-size: 1.3rem;
            width: 24px;
            text-align: center;
        }
        
        .logout-section {
            padding: 20px;
            border-top: 2px solid #e8f0f8;
        }
        
        .logout-btn {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #c62828 0%, #d32f2f 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(198, 40, 40, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(198, 40, 40, 0.4);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
        }
        
        .content-header {
            background: rgba(255, 255, 255, 0.98);
            padding: 25px 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.1);
            border-top: 4px solid #2c5aa0;
        }
        
        .content-header h2 {
            color: #1e3a5f;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .content-header p {
            color: #666;
            font-size: 1rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        /* Calendar Section */
        .calendar-section {
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.1);
            border-top: 4px solid #2c5aa0;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .calendar-header h3 {
            color: #1e3a5f;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .calendar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .calendar-btn {
            background: #2c5aa0;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .calendar-btn:hover {
            background: #1e3a5f;
            transform: translateY(-2px);
        }
        
        .calendar-month {
            color: #1e3a5f;
            font-weight: 700;
            font-size: 1.1rem;
            min-width: 150px;
            text-align: center;
        }
        
        .calendar {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e8f0f8;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5aa0 100%);
            color: white;
        }
        
        .calendar-day-header {
            padding: 12px;
            text-align: center;
            font-weight: 700;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }
        
        .calendar-dates {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e8f0f8;
        }
        
        .calendar-date {
            background: white;
            padding: 15px;
            min-height: 80px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .calendar-date:hover {
            background: rgba(44, 90, 160, 0.05);
            transform: scale(1.02);
        }
        
        .calendar-date.other-month {
            color: #ccc;
            background: #fafbfd;
        }
        
        .calendar-date.today {
            background: linear-gradient(135deg, #2c5aa0 0%, #1e3a5f 100%);
            color: white;
            font-weight: 700;
        }
        
        .calendar-date.has-event::after {
            content: '';
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: #4caf50;
            border-radius: 50%;
        }
        
        .calendar-date.today.has-event::after {
            background: #ffd700;
        }
        
        .date-number {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .date-event {
            font-size: 0.7rem;
            color: #2c5aa0;
            font-weight: 600;
            margin-top: 5px;
        }
        
        /* Upcoming Events Section */
        .events-section {
            background: rgba(255, 255, 255, 0.98);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.1);
            border-top: 4px solid #2c5aa0;
        }
        
        .events-section h3 {
            color: #1e3a5f;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .event-card {
            background: #f8fafe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #2c5aa0;
            transition: all 0.3s ease;
        }
        
        .event-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .event-date {
            color: #2c5aa0;
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }
        
        .event-title {
            color: #1e3a5f;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .event-location {
            color: #666;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .event-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-top: 8px;
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .no-events {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .no-events-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.98);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 24px rgba(0,0,0,0.1);
            border-top: 4px solid #2c5aa0;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }
        
        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .stat-value {
            color: #2c5aa0;
            font-size: 2rem;
            font-weight: 700;
        }
        
        /* Page Content */
        .page-content {
            display: none;
        }
        
        .page-content.active {
            display: block;
            animation: fadeInUp 0.5s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .coming-soon {
            background: rgba(255, 255, 255, 0.98);
            padding: 60px 40px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 6px 24px rgba(0,0,0,0.1);
            border-top: 4px solid #2c5aa0;
        }
        
        .coming-soon-icon {
            font-size: 5rem;
            margin-bottom: 20px;
            opacity: 0.6;
        }
        
        .coming-soon h3 {
            color: #1e3a5f;
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .coming-soon p {
            color: #666;
            font-size: 1.1rem;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            
            .nav-menu {
                display: flex;
                flex-wrap: wrap;
                padding: 10px;
            }
            
            .nav-item {
                flex: 1 1 calc(50% - 10px);
                margin: 5px;
                border-left: none;
                border-top: 3px solid transparent;
                justify-content: center;
            }
            
            .nav-item.active {
                border-left: none;
                border-top-color: #2c5aa0;
            }
            
            .logout-section {
                padding: 10px;
            }
            
            .calendar-dates {
                gap: 0;
            }
            
            .calendar-date {
                min-height: 60px;
                padding: 10px 5px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h1>ECP</h1>
                <p>Student Portal</p>
            </div>
            
            <div class="user-info" id="userInfo">
                <h3 id="studentName">Loading...</h3>
                <p id="studentNumber">Student #: Loading...</p>
                <p id="studentCourse">Course: Loading...</p>
            </div>
            
    <nav class="nav-menu">
        <a class="nav-item active" onclick="showPage('dashboard')">
            <span class="nav-item-icon">📊</span>
            <span>Dashboard</span>
    </a>
        <a class="nav-item" onclick="showPage('register')">
            <span class="nav-item-icon">✏️</span>
            <span>Event Registration</span>
    </a>
        <a class="nav-item" onclick="showPage('venues')">
            <span class="nav-item-icon">🏢</span>
            <span>Venues</span>
        </a>
        <a class="nav-item" onclick="showPage('evaluation')">
            <span class="nav-item-icon">⭐</span>
            <span>Post-Evaluation</span>
        </a>
        <a class="nav-item" onclick="showPage('myevents')">
            <span class="nav-item-icon">📅</span>
            <span>My Events</span>
        </a>
    </nav>
            
            <div class="logout-section">
                <button class="logout-btn" onclick="logout()">
                    <span>🚪</span>
                    <span>Logout</span>
                </button>
            </div>
        </aside>
        
        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard" class="page-content active">
                <div class="content-header">
                    <h2>Welcome Back, <span id="welcomeName">Student</span>! 👋</h2>
                    <p>Here's what's happening with your events today</p>
                </div>
                
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">📝</div>
                <div class="stat-label">Registered Events</div>
                <div class="stat-value" id="registeredCount">0</div>
        </div>
        <div class="stat-card">
                <div class="stat-icon">🎯</div>
                <div class="stat-label">Available Events</div>
                <div class="stat-value" id="availableCount">0</div>
        </div>
        <div class="stat-card">
                <div class="stat-icon">✅</div>
                <div class="stat-label">Attended Events</div>
                <div class="stat-value" id="attendedCount">0</div>
        </div>
        <div class="stat-card">
                <div class="stat-icon">⭐</div>
                <div class="stat-label">Pending Post-Evaluation</div>
            <div class="stat-value" id="pendingEvalCount">0</div>
        </div>
        </div>
                
                <div class="dashboard-grid">
                    <!-- Calendar Section -->
                    <div class="calendar-section">
                        <div class="calendar-header">
                            <h3>📆 Event Calendar</h3>
                            <div class="calendar-controls">
                                <button class="calendar-btn" onclick="previousMonth()">◀</button>
                                <span class="calendar-month" id="currentMonth">October 2025</span>
                                <button class="calendar-btn" onclick="nextMonth()">▶</button>
                            </div>
                        </div>
                        
                        <div class="calendar">
                            <div class="calendar-days">
                                <div class="calendar-day-header">SUN</div>
                                <div class="calendar-day-header">MON</div>
                                <div class="calendar-day-header">TUE</div>
                                <div class="calendar-day-header">WED</div>
                                <div class="calendar-day-header">THU</div>
                                <div class="calendar-day-header">FRI</div>
                                <div class="calendar-day-header">SAT</div>
                            </div>
                            <div class="calendar-dates" id="calendarDates">
                                <!-- Calendar dates will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Upcoming Events Section -->
                    <div class="events-section">
                        <h3>🎉 Upcoming Events</h3>
                        <div id="upcomingEventsList">
                            <div class="no-events">
                                <div class="no-events-icon">📭</div>
                                <p>No upcoming events</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Event Registration Page -->
            <div id="register" class="page-content">
                <div class="content-header">
                    <h2>Event Registration</h2>
                    <p>Browse and register for upcoming university events</p>
                </div>
                <div class="coming-soon">
                    <div class="coming-soon-icon">🚧</div>
                    <h3>Coming Soon</h3>
                    <p>Event registration feature is under development</p>
                </div>
            </div>
            
            <!-- Venues Page -->
            <div id="venues" class="page-content">
                <div class="content-header">
                    <h2>University Venues</h2>
                    <p>Explore available venues for events</p>
                </div>
                <div class="coming-soon">
                    <div class="coming-soon-icon">🏛️</div>
                    <h3>Coming Soon</h3>
                    <p>Venues directory is under development</p>
                </div>
            </div>
            
            <!-- Post-Evaluation Page -->
            <div id="evaluation" class="page-content">
                <div class="content-header">
                    <h2>Post-Event Evaluation</h2>
                    <p>Share your feedback on attended events</p>
                </div>
                <div class="coming-soon">
                    <div class="coming-soon-icon">📝</div>
                    <h3>Coming Soon</h3>
                    <p>Event evaluation feature is under development</p>
                </div>
            </div>

            <!-- My Events Page -->
            <div id="myevents" class="page-content">
                <div class="content-header">
                    <h2>My Events</h2>
                    <p>View and manage your registered events</p>
                </div>
                <div class="coming-soon">
                    <div class="coming-soon-icon">📋</div>
                    <h3>Coming Soon</h3>
                    <p>My Events management feature is under development</p>
                </div>
            </div>
        </main>
    </div>
    
<script>
    // API Configuration
    const API_BASE = '../../api';
    let currentStudentId = null;
    let calendarEventsData = [];
    
    // Load user session data
    function loadUserSession() {
        const session = localStorage.getItem('user_session');
        if (!session) {
            window.location.href = '../../login.html';
            return null;
        }
        
        const userData = JSON.parse(session);
        
        // Check if user is student
        if (userData.user_type !== 'student') {
            alert('Access denied. This portal is for students only.');
            localStorage.removeItem('user_session');
            window.location.href = '../../login.html';
            return null;
        }
        
        // Display user information
        document.getElementById('studentName').textContent = `${userData.firstname} ${userData.lastname}`;
        document.getElementById('studentNumber').textContent = `Student #: ${userData.username}`;
        document.getElementById('studentCourse').textContent = `Course: ${userData.department || 'N/A'}`;
        document.getElementById('welcomeName').textContent = userData.firstname;
        
        currentStudentId = userData.user_id;
        return userData;
    }
    
    // Load dashboard data from API
    // Load dashboard data from API
async function loadDashboardData() {
    if (!currentStudentId) {
        console.error('No student ID available');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/student_dashboard.php?student_id=${currentStudentId}`);
        const result = await response.json();
        
        if (result.success) {
            // Update stats cards
            document.getElementById('registeredCount').textContent = result.stats.registered_events;
            document.getElementById('availableCount').textContent = result.stats.available_events;
            document.getElementById('attendedCount').textContent = result.stats.attended_events;
            document.getElementById('pendingEvalCount').textContent = result.stats.pending_evaluation;
            
            // Update upcoming events count in header
            document.getElementById('upcomingCount').textContent = result.upcoming_events.length;
            
            // Store calendar events for current month
            calendarEventsData = result.calendar_events;
            
            // Render upcoming events
            renderUpcomingEvents(result.upcoming_events);
            
            // Load calendar events for the current month
            loadCalendarEvents();
        } else {
            console.error('Failed to load dashboard data:', result.message);
            showNotification('Failed to load dashboard data', 'error');
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showNotification('Error connecting to server. Please check if XAMPP is running.', 'error');
    }
}
    
    // Render upcoming events list
    function renderUpcomingEvents(events) {
        const upcomingList = document.getElementById('upcomingEventsList');
        
        if (!events || events.length === 0) {
            upcomingList.innerHTML = `
                <div class="no-events">
                    <div class="no-events-icon">🔭</div>
                    <p>No upcoming events</p>
                </div>
            `;
            return;
        }
        
        upcomingList.innerHTML = events.map(event => {
            const eventDate = new Date(event.event_date);
            const formattedDate = eventDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            });
            
            const startTime = formatTime(event.start_time);
            const endTime = formatTime(event.end_time);
            
            return `
                <div class="event-card">
                    <div class="event-date">📅 ${formattedDate}</div>
                    <div class="event-title">${event.event_name}</div>
                    <div class="event-location">📍 ${event.venue_name} - ${event.location}</div>
                    <div class="event-location">🕐 ${startTime} - ${endTime}</div>
                    <span class="event-status">${event.registration_status}</span>
                </div>
            `;
        }).join('');
    }
    
    // Format time from HH:MM:SS to 12-hour format
    function formatTime(timeString) {
        const [hours, minutes] = timeString.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour % 12 || 12;
        return `${displayHour}:${minutes} ${ampm}`;
    }
    
    // Show notification
    function showNotification(message, type = 'info') {
        // You can implement a better notification system later
        console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    // Page navigation
    function showPage(pageName) {
        // Hide all pages
        document.querySelectorAll('.page-content').forEach(page => {
            page.classList.remove('active');
        });
        
        // Remove active class from all nav items
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Show selected page
        document.getElementById(pageName).classList.add('active');
        
        // Add active class to clicked nav item
        event.target.closest('.nav-item').classList.add('active');
    }
    
    // Logout function
    function logout() {
        if (confirm('Are you sure you want to logout?')) {
            localStorage.removeItem('user_session');
            window.location.href = '../../login.html';
        }
    }
    
    // Calendar functionality
    let currentDate = new Date();
    
    function renderCalendar() {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    // Update month display
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`;
    
    // Get first day of month and number of days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    
    const calendarDates = document.getElementById('calendarDates');
    calendarDates.innerHTML = '';
    
    // Today's date for highlighting
    const today = new Date();
    const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
    
    // Create a map of event dates for the current displayed month
    const eventsByDate = {};
    if (calendarEventsData && calendarEventsData.length > 0) {
        calendarEventsData.forEach(event => {
            const eventDate = new Date(event.event_date);
            if (eventDate.getFullYear() === year && eventDate.getMonth() === month) {
                const day = eventDate.getDate();
                if (!eventsByDate[day]) {
                    eventsByDate[day] = [];
                }
                eventsByDate[day].push(event);
            }
        });
    }
    
    console.log('Events for current month:', eventsByDate); // Debug log
    
    // Previous month days
    for (let i = firstDay - 1; i >= 0; i--) {
        const date = daysInPrevMonth - i;
        const dateDiv = document.createElement('div');
        dateDiv.className = 'calendar-date other-month';
        dateDiv.innerHTML = `<div class="date-number">${date}</div>`;
        calendarDates.appendChild(dateDiv);
    }
    
    // Current month days
    for (let i = 1; i <= daysInMonth; i++) {
        const dateDiv = document.createElement('div');
        dateDiv.className = 'calendar-date';
        
        // Highlight today
        if (isCurrentMonth && i === today.getDate()) {
            dateDiv.classList.add('today');
        }
        
        // Add event indicator if there are events on this date
        if (eventsByDate[i] && eventsByDate[i].length > 0) {
            dateDiv.classList.add('has-event');
            
            // Optional: Show event count or name
            const eventCount = eventsByDate[i].length;
            const eventInfo = eventCount === 1 
                ? `<div class="date-event">${eventsByDate[i][0].event_name.substring(0, 15)}...</div>`
                : `<div class="date-event">${eventCount} events</div>`;
            
            dateDiv.innerHTML = `
                <div class="date-number">${i}</div>
                ${eventInfo}
            `;
        } else {
            dateDiv.innerHTML = `<div class="date-number">${i}</div>`;
        }
        
        // Add click event to show event details
        if (eventsByDate[i]) {
            dateDiv.style.cursor = 'pointer';
            dateDiv.onclick = () => showEventDetails(eventsByDate[i]);
        }
        
        calendarDates.appendChild(dateDiv);
    }
    
    // Next month days to fill grid
    const totalCells = calendarDates.children.length;
    const remainingCells = 42 - totalCells; // 6 rows × 7 days
    
    for (let i = 1; i <= remainingCells; i++) {
        const dateDiv = document.createElement('div');
        dateDiv.className = 'calendar-date other-month';
        dateDiv.innerHTML = `<div class="date-number">${i}</div>`;
        calendarDates.appendChild(dateDiv);
    }
}

// Show event details when clicking on a calendar date
function showEventDetails(events) {
    const eventList = events.map(event => {
        const startTime = formatTime(event.start_time);
        const endTime = formatTime(event.end_time);
        return `• ${event.event_name} (${startTime} - ${endTime})`;
    }).join('\n');
    
    alert(`Events on this date:\n\n${eventList}`);
}

// Update previousMonth and nextMonth to reload events when month changes
function previousMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    loadCalendarEvents(); // Load events for the new month
}

function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    loadCalendarEvents(); // Load events for the new month
}

// New function to load calendar events for the current displayed month
async function loadCalendarEvents() {
    if (!currentStudentId) {
        console.error('No student ID available');
        return;
    }
    
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1; // JavaScript months are 0-indexed
    
    try {
        const response = await fetch(`${API_BASE}/student_calendar.php?student_id=${currentStudentId}&year=${year}&month=${month}`);
        const result = await response.json();
        
        if (result.success) {
            calendarEventsData = result.calendar_events;
            renderCalendar();
        } else {
            console.error('Failed to load calendar events:', result.message);
        }
    } catch (error) {
        console.error('Error loading calendar events:', error);
    }
}
    
    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        const userData = loadUserSession();
        if (userData) {
            renderCalendar();
            loadDashboardData();
        }
    });
</script>
</body>
</html>