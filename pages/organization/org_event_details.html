<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>University of Makati - Event Details</title>
  <style>
    /* GLOBAL */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Century Gothic', sans-serif;
    }

    body {
      background-color: #f4f5f7;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* NAVIGATION BAR */
    nav {
      background-color: #022d6d;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 30px;
      height: 60px;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    nav img {
      height: 35px;
      margin-left: 10px;
    }

    .nav-title {
      display: flex;
      flex-direction: column;
      line-height: 1.2;
    }

    .nav-title .main-title {
      font-size: 16px;
      font-weight: bold;
    }

    .nav-title .org-name {
      font-size: 12px;
      color: #f36b00;
      font-weight: normal;
    }

    /* SIDEBAR */
    .sidebar {
      position: fixed;
      top: 60px; 
      left: 0;
      width: 220px;
      background-color: white;
      bottom: 0;
      border-right: 1px solid #ddd;
      padding-top: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .sidebar a {
      display: block;
      padding: 12px 20px;
      color: #022d6d;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background-color: #022d6d;
      color: white;
      border-radius: 4px;
      margin: 0 10px;
    }

    .logout-btn {
      background-color: #f30000;
      color: white;
      border: none;
      width: 80%;
      padding: 10px;
      margin: 20px auto;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
    }

    .logout-btn:hover {
      background-color: #d00000;
    }

    /* MAIN CONTENT */
    .main-content {
      margin-left: 230px;
      margin-top: 80px; 
      padding: 30px;
      flex: 1;
    }

    /* BACK BUTTON */
    .back-btn {
      background-color: #6c757d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-bottom: 20px;
      transition: 0.3s;
    }

    .back-btn:hover {
      background-color: #5a6268;
    }

    /* EVENT HEADER */
    .event-header {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }

    .event-banner {
      width: 400px;
      height: 250px;
      background-size: cover;
      background-position: center;
      border-radius: 8px;
      background-color: #ddd;
      flex-shrink: 0;
    }

    .event-info {
      flex: 1;
      min-width: 300px;
    }

    .event-title-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .event-title {
      color: #022d6d;
      font-size: 28px;
      font-weight: bold;
    }

    .status-badge {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: bold;
      text-transform: capitalize;
    }

    .status-Draft { background-color: #6c757d; color: white; }
    .status-Published { background-color: #007bff; color: white; }
    .status-Registration.Open { background-color: #28a745; color: white; }
    .status-Registration.Closed { background-color: #dc3545; color: white; }
    .status-Ongoing { background-color: #ffc107; color: #333; }
    .status-Completed { background-color: #17a2b8; color: white; }
    .status-Cancelled { background-color: #dc3545; color: white; }

    .event-details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .detail-item {
      display: flex;
      gap: 10px;
    }

    .detail-label {
      color: #666;
      font-weight: bold;
      min-width: 120px;
    }

    .detail-value {
      color: #022d6d;
    }

    /* REQUIREMENTS SECTION STYLE */
    .req-box {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    .req-box h4 {
        color: #022d6d;
        font-size: 16px;
        margin-bottom: 10px;
    }
    .req-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }
    .req-tag {
        background: #f0f4f8;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        color: #333;
        border: 1px solid #ddd;
    }

    /* APPROVAL TRACKER STYLES */
    .approval-tracker {
      background-color: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .tracker-header {
      color: #022d6d;
      font-size: 18px;
      margin-bottom: 20px;
      border-bottom: 2px solid #f36b00;
      padding-bottom: 10px;
    }

    .tracker-steps {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .tracker-step {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 1px solid #eee;
      border-radius: 6px;
      background: #f9f9f9;
      transition: 0.3s;
    }

    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
      font-size: 18px;
    }

    .icon-pending { background-color: #e9ecef; color: #6c757d; }
    .icon-approved { background-color: #d4edda; color: #155724; }
    .icon-rejected { background-color: #f8d7da; color: #721c24; }

    .step-content { flex: 1; }
    .step-title { font-weight: bold; color: #333; font-size: 15px; }
    .step-status { font-size: 13px; margin-top: 3px; }
    .step-status.pending { color: #6c757d; font-style: italic; }
    .step-status.approved { color: #28a745; font-weight: bold; }
    .step-status.rejected { color: #dc3545; font-weight: bold; }

    .step-remarks {
      margin-top: 5px;
      font-size: 12px;
      color: #555;
      background: #fff;
      padding: 8px;
      border-left: 3px solid #f36b00;
    }
    
    .event-description {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }

    .event-description h3 {
      color: #022d6d;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .event-description p {
      color: #333;
      line-height: 1.6;
      white-space: pre-line;
    }

    .event-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: 0.3s;
    }

    .btn-edit {
      background-color: #f36b00;
      color: white;
    }

    .btn-edit:hover {
      background-color: #d45a00;
    }

    .btn-delete {
      background-color: #dc3545;
      color: white;
    }

    .btn-delete:hover {
      background-color: #c82333;
    }

    /* STATS CARDS */
    .stats-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-card {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
    }

    .stat-card h4 {
      color: #666;
      font-size: 14px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-card p {
      color: #022d6d;
      font-size: 32px;
      font-weight: bold;
    }

    /* REGISTRATIONS SECTION */
    .registrations-section {
      background-color: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-header h3 {
      color: #022d6d;
      font-size: 20px;
    }

    /* SEARCH AND FILTER */
    .table-controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .search-box {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    .filter-select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      min-width: 150px;
    }

    /* REGISTRATIONS TABLE */
    .registrations-table {
      width: 100%;
      border-collapse: collapse;
    }

    .registrations-table th,
    .registrations-table td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #ddd;
    }

    .registrations-table th {
      background-color: #022d6d;
      color: white;
      font-weight: bold;
      font-size: 14px;
    }

    .registrations-table tr:hover {
      background-color: #f9f9f9;
    }

    .status-Registered { color: #007bff; font-weight: bold; }
    .status-Attended { color: #28a745; font-weight: bold; }
    .status-Cancelled { color: #dc3545; font-weight: bold; }
    .status-No-Show { color: #ffc107; font-weight: bold; }

    .no-registrations {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    /* CUSTOM ALERT STYLES */
    .custom-alert-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .custom-alert-overlay.show {
      display: flex;
    }

    .custom-alert-box {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      width: 400px;
      max-width: 90%;
      overflow: hidden;
    }

    .custom-alert-header {
      background-color: #022d6d;
      color: white;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .custom-alert-body {
      padding: 20px;
      font-size: 14px;
      color: #333;
    }

    .custom-alert-footer {
      padding: 15px 20px;
      text-align: right;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .custom-alert-btn {
      background-color: #022d6d;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    .custom-alert-btn-cancel {
        background-color: #ccc;
        color: #333;
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 10px;
    }

    /* FOOTER */
    footer {
      background-color: #242424;
      color: #f36b00;
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      padding: 40px 80px;
      font-size: 16px;
      flex-wrap: wrap;
      margin-top: 40px;
    }

    footer .footer-section {
      max-width: 400px;
      margin-left: 80px;
    }

    footer h4 {
      color: #f36b00;
      margin-bottom: 10px;
    }

    footer p {
      color: white;
      font-size: 14px;
      line-height: 1.6;
    }

    footer a {
      color: white;
      text-decoration: underline;
      font-size: 14px;
    }

    footer a:hover {
      color: #f36b00;
    }

    @media (max-width: 768px) {
      .main-content { margin-left: 0; padding: 20px; }
      .sidebar { display: none; }
      .event-header { flex-direction: column; }
      .event-banner { width: 100%; }
      .event-details-grid { grid-template-columns: 1fr; }
    }
    .nav-right .account-link { color: #ccc; font-size: 12px; text-decoration: none; border: 1px solid #ccc; padding: 5px 10px; border-radius: 15px; transition: 0.3s; }
    .nav-right .account-link:hover { color: white; border-color: white; }
  </style>
</head>

<body>

  <!-- CUSTOM ALERT -->
  <div class="custom-alert-overlay" id="customAlertOverlay">
    <div class="custom-alert-box">
      <div class="custom-alert-header"><span id="alertIcon">ℹ️</span><span id="alertTitle">Message</span></div>
      <div class="custom-alert-body" id="alertBody"></div>
      <div class="custom-alert-footer" id="alertFooter"></div>
    </div>
  </div>

  <nav>
    <div class="nav-left">
      <img src="../../images/UMAK LOGO.png" alt="UMak Logo">
      <div class="nav-title">
        <span class="main-title">University of Makati - ECP</span>
        <span class="org-name" id="orgNameDisplay">Loading...</span>
      </div>
    </div>
    <div class="nav-right">
        <a href="org_account.html" class="account-link">⚙️ Settings</a>
    </div>
  </nav>


  <div class="sidebar">
    <div>
      <a href="org_dashboard.html">Dashboard</a>
      <a href="org_events.html" class="active">My Events</a>
      <a href="org_create_event.html">Create Event</a>
      <a href="org_scan_qr.html">Scan QR Code</a>
      <a href="org_evaluations.html">Evaluations</a>
      <a href="org_messages.html">Messages</a>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="main-content">
    <button class="back-btn" onclick="goBack()">← Back to My Events</button>

    <div class="event-header">
      <div class="event-banner" id="eventBanner"></div>
      <div class="event-info">
        <div class="event-title-row">
          <h1 class="event-title" id="eventTitle">Loading...</h1>
          <span class="status-badge" id="statusBadge"></span>
        </div>

        <div class="event-details-grid">
          <div class="detail-item"><span class="detail-label">Date:</span><span class="detail-value" id="eventDate">-</span></div>
          <div class="detail-item"><span class="detail-label">Time:</span><span class="detail-value" id="eventTime">-</span></div>
          <div class="detail-item"><span class="detail-label">Venue:</span><span class="detail-value" id="eventVenue">-</span></div>
          <div class="detail-item"><span class="detail-label">Event Type:</span><span class="detail-value" id="eventType">-</span></div>
          <div class="detail-item"><span class="detail-label">College:</span><span class="detail-value" id="targetCollege">-</span></div>
          <div class="detail-item"><span class="detail-label">Year:</span><span class="detail-value" id="targetYear">-</span></div>
          <div class="detail-item"><span class="detail-label">Priority:</span><span class="detail-value" id="eventPriority">-</span></div>
          <div class="detail-item"><span class="detail-label">Eval Required:</span><span class="detail-value" id="requiresEval">-</span></div>
        </div>

        <div class="req-box">
            <h4>Requested Logistics</h4>
            <div class="req-list" id="reqList">
                <!-- Injected via JS -->
            </div>
        </div>

        <div class="event-description">
          <h3>Description</h3>
          <p id="eventDescription">Loading description...</p>
        </div>

        <div class="event-actions">
          <button class="btn btn-edit" onclick="editEvent()">Edit Event</button>
          <button class="btn btn-delete" onclick="deleteEvent()">Cancel Event</button>
        </div>
      </div>
    </div>

    <!-- APPROVAL TRACKER SECTION -->
    <div class="approval-tracker">
        <h3 class="tracker-header">Approval Status</h3>
        <div class="tracker-steps" id="trackerContainer">
            <!-- Populated via JS -->
        </div>
    </div>

    <div class="stats-section">
      <div class="stat-card">
        <h4>Capacity</h4>
        <p id="totalCapacity">0</p>
      </div>
      <div class="stat-card">
        <h4>Registered</h4>
        <p id="totalRegistered">0</p>
      </div>
      <div class="stat-card">
        <h4>Attended</h4>
        <p id="totalAttended">0</p>
      </div>
      <div class="stat-card">
        <h4>Available</h4>
        <p id="availableSlots">0</p>
      </div>
    </div>

    <div class="registrations-section">
      <div class="section-header">
        <h3>Event Registrations</h3>
      </div>

      <div class="table-controls">
        <input type="text" class="search-box" id="searchRegistration" placeholder="Search by name or student number..." onkeyup="filterRegistrations()">
        <select class="filter-select" id="filterStatus" onchange="filterRegistrations()">
          <option value="all">All Status</option>
          <option value="Registered">Registered</option>
          <option value="Attended">Attended</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>

      <table class="registrations-table">
        <thead>
          <tr>
            <th>Student #</th>
            <th>Name</th>
            <th>College</th>
            <th>Course</th>
            <th>Year & Section</th>
            <th>Reg Date</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="registrationsTableBody">
          <tr><td colspan="7" class="no-registrations">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <footer>
    <div class="footer-section">
      <h4>About ECP</h4>
      <p>The Event Coordination Portal serves as the central management system for events organized by the colleges of the University of Makati.</p>
    </div>
    <div class="footer-section">
      <h4>Links</h4>
      <a href="https://www.umak.edu.ph/" target="_blank">University of Makati</a>
    </div>
  </footer>

  <script>
    const API_BASE = '../../api';
    const orgId = localStorage.getItem('orgId');
    const orgName = localStorage.getItem('orgName');
    
    if(!orgId) window.location.href = '../login_signup.html';
    document.getElementById('orgNameDisplay').textContent = orgName;

    // Get event ID
    const urlParams = new URLSearchParams(window.location.search);
    const eventId = urlParams.get('id');

    let allRegistrations = [];

    // --- ALERT UTILS ---
    function customAlert(msg, type='info', callback) {
        const overlay = document.getElementById('customAlertOverlay');
        const title = document.getElementById('alertTitle');
        const body = document.getElementById('alertBody');
        const footer = document.getElementById('alertFooter');
        const icon = document.getElementById('alertIcon');

        body.textContent = msg;
        overlay.classList.add('show');

        if(type==='confirm') {
            title.textContent = 'Confirm'; 
            icon.textContent = '❓';
            footer.innerHTML = `
                <button class="custom-alert-btn-cancel" id="btnCancel">Cancel</button>
                <button class="custom-alert-btn" id="btnOk">Confirm</button>
            `;
            document.getElementById('btnOk').onclick = () => { overlay.classList.remove('show'); if(callback) callback(true); };
            document.getElementById('btnCancel').onclick = () => { overlay.classList.remove('show'); if(callback) callback(false); };
        } else {
            title.textContent = type==='error'?'Error':'Success'; 
            icon.textContent = type==='error'?'❌':'✅';
            footer.innerHTML = `<button class="custom-alert-btn" onclick="document.getElementById('customAlertOverlay').classList.remove('show')">OK</button>`;
        }
    }

    async function loadEventData() {
        if (!eventId) {
            customAlert('No Event ID provided.', 'error');
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/org_event_details.php?event_id=${eventId}&org_id=${orgId}`);
            const data = await res.json();

            if (data.success) {
                const event = data.event;
                const stats = data.stats;
                const reqs = data.requirements || {};
                allRegistrations = data.registrations;
                const approvals = data.approvals;

                // Populate Info
                document.getElementById('eventTitle').textContent = event.event_name;
                document.getElementById('statusBadge').textContent = event.status;
                document.getElementById('statusBadge').className = `status-badge status-${event.status.replace(' ', '.')}`;
                
                // Banner
                const banner = document.getElementById('eventBanner');
                if(event.banner_image) {
                    banner.style.backgroundImage = `url('${event.banner_image}')`;
                } else {
                    banner.style.background = 'linear-gradient(135deg, #022d6d 0%, #00509e 100%)';
                }

                document.getElementById('eventDate').textContent = new Date(event.event_date).toDateString();
                document.getElementById('eventTime').textContent = `${formatTime(event.start_time)} - ${formatTime(event.end_time)}`;
                document.getElementById('eventVenue').textContent = event.venue_name || 'TBD';
                document.getElementById('eventType').textContent = event.event_type;
                document.getElementById('targetCollege').textContent = event.target_college;
                document.getElementById('targetYear').textContent = event.target_year_level;
                document.getElementById('eventPriority').textContent = event.event_prioritization;
                document.getElementById('requiresEval').textContent = (event.requires_evaluation == 1) ? "Yes" : "No";
                document.getElementById('eventDescription').textContent = event.description;

                // Populate Stats
                document.getElementById('totalCapacity').textContent = stats.capacity;
                document.getElementById('totalRegistered').textContent = stats.registered;
                document.getElementById('totalAttended').textContent = stats.attended;
                document.getElementById('availableSlots').textContent = stats.available;

                // Populate Logistics
                const reqList = document.getElementById('reqList');
                reqList.innerHTML = '';
                if(reqs.needs_internet) reqList.innerHTML += `<span class="req-tag">Internet</span>`;
                if(reqs.needs_projector) reqList.innerHTML += `<span class="req-tag">Projector</span>`;
                if(reqs.needs_sound_system) reqList.innerHTML += `<span class="req-tag">Sound System</span>`;
                if(reqs.needs_chairs > 0) reqList.innerHTML += `<span class="req-tag">Chairs (${reqs.needs_chairs})</span>`;
                if(reqs.needs_tables > 0) reqList.innerHTML += `<span class="req-tag">Tables (${reqs.needs_tables})</span>`;
                if(reqs.needs_cleaning) reqList.innerHTML += `<span class="req-tag">Cleaning</span>`;
                if(reqs.needs_medical) reqList.innerHTML += `<span class="req-tag">Medical</span>`;
                if(reqs.needs_parking) reqList.innerHTML += `<span class="req-tag">Parking</span>`;
                if(reqs.has_food) reqList.innerHTML += `<span class="req-tag">Food/Catering</span>`;
                if(!reqList.innerHTML) reqList.innerHTML = `<span style="font-size:12px; color:#666;">No special requirements listed.</span>`;

                // Populate Approval Tracker
                renderApprovalTracker(approvals, reqs);

                // Populate Table
                renderRegistrations(allRegistrations);

            } else {
                customAlert(data.message, 'error');
                setTimeout(() => window.location.href = 'org_events.html', 2000);
            }
        } catch (e) {
            console.error(e);
            customAlert("Connection error.", 'error');
        }
    }

    function renderApprovalTracker(approvals, reqs) {
        const container = document.getElementById('trackerContainer');
        container.innerHTML = '';

        // Map DB records to object for easy lookup
        const appMap = {};
        if (approvals) {
            approvals.forEach(a => appMap[a.department] = a);
        }

        // Define Required Steps
        const steps = [
            { id: 'CSOA', name: 'CSOA (Student Activities)', required: true },
            { id: 'UFMO', name: 'UFMO (Facilities)', required: true }
        ];

        // Add Conditional Steps
        if (reqs.needs_internet || reqs.needs_projector) steps.push({ id: 'CIT', name: 'CIT (IT Support)', required: true });
        if (reqs.needs_medical || reqs.has_food || reqs.needs_parking) steps.push({ id: 'OHSO', name: 'OHSO (Health & Safety)', required: true });
        if (reqs.needs_chairs || reqs.needs_tables) steps.push({ id: 'SPMO', name: 'SPMO (Property Mgmt)', required: true });
        if (reqs.needs_cleaning || reqs.needs_sound_system) steps.push({ id: 'GSO', name: 'GSO (General Services)', required: true });
        if (reqs.rental_fee > 0) steps.push({ id: 'Accounting', name: 'Accounting Office', required: true });

        steps.forEach(step => {
            const record = appMap[step.id];
            const status = record ? record.status : 'Pending';
            const remarks = record && record.remarks ? record.remarks : '';
            
            let icon = '⏳';
            let iconClass = 'icon-pending';
            let statusClass = 'pending';

            if (status === 'Approved') {
                icon = '✓';
                iconClass = 'icon-approved';
                statusClass = 'approved';
            } else if (status === 'Rejected') {
                icon = '✖';
                iconClass = 'icon-rejected';
                statusClass = 'rejected';
            }

            let html = `
                <div class="tracker-step">
                    <div class="step-icon ${iconClass}">${icon}</div>
                    <div class="step-content">
                        <div class="step-title">${step.name}</div>
                        <div class="step-status ${statusClass}">${status.toUpperCase()}</div>
                        ${remarks ? `<div class="step-remarks"><strong>Note:</strong> ${remarks}</div>` : ''}
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    function renderRegistrations(list) {
        const tbody = document.getElementById('registrationsTableBody');
        tbody.innerHTML = '';

        if (list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="no-registrations">No students registered yet.</td></tr>';
            return;
        }

        list.forEach(r => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${r.student_number}</td>
                <td>${r.lastname}, ${r.firstname}</td>
                <td>${r.college}</td>
                <td>${r.course}</td>
                <td>${r.year_level}-${r.section}</td>
                <td>${new Date(r.registration_date).toLocaleDateString()}</td>
                <td><span class="status-${r.status}">${r.status}</span></td>
            `;
            tbody.appendChild(row);
        });
    }

    function filterRegistrations() {
        const search = document.getElementById('searchRegistration').value.toLowerCase();
        const status = document.getElementById('filterStatus').value;

        const filtered = allRegistrations.filter(r => {
            const matchSearch = r.lastname.toLowerCase().includes(search) || 
                                r.firstname.toLowerCase().includes(search) ||
                                r.student_number.toLowerCase().includes(search);
            const matchStatus = status === 'all' || r.status === status;
            return matchSearch && matchStatus;
        });
        renderRegistrations(filtered);
    }

    function formatTime(timeStr) {
        const [h, m] = timeStr.split(':');
        const hour = parseInt(h);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayH = hour % 12 || 12;
        return `${displayH}:${m} ${ampm}`;
    }

    function goBack() { window.location.href = 'org_events.html'; }
    function editEvent() { window.location.href = `org_edit_event.html?id=${eventId}`; }

    function deleteEvent() {
        customAlert("Are you sure you want to cancel this event?", 'confirm', async (confirmed) => {
            if(confirmed) {
                try {
                    const res = await fetch(`${API_BASE}/org_events.php?event_id=${eventId}`, { method: 'DELETE' });
                    const data = await res.json();
                    if(data.success) {
                        customAlert("Event Cancelled.", 'success');
                        setTimeout(() => window.location.href = 'org_events.html', 1500);
                    } else {
                        customAlert(data.message, 'error');
                    }
                } catch(e) { customAlert("Connection Error", 'error'); }
            }
        });
    }

    function logout() {
        customAlert("Are you sure you want to logout?", 'confirm', (c) => {
            if(c) {
                localStorage.removeItem('orgId');
                window.location.href = '../login_signup.html';
            }
        });
    }

    loadEventData();
  </script>
</body>
</html>