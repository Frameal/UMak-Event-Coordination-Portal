<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Dashboard - UMak ECP</title>
  <!-- FullCalendar CSS -->
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
  <style>
    /* GLOBAL STYLES */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Century Gothic', sans-serif;
    }

    body {
      background-color: #f4f5f7;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* NAVIGATION BAR */
    nav {
      background-color: #022d6d;
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 30px;
      height: 60px;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    nav img {
      height: 35px;
      margin-left: 10px;
    }

    nav span {
      font-size: 16px;
      font-weight: bold;
      letter-spacing: 0.5px;
    }

    .nav-right .account-link {
      color: #ccc;
      font-size: 12px;
      text-decoration: none;
      border: 1px solid #ccc;
      padding: 5px 10px;
      border-radius: 15px;
      transition: 0.3s;
    }

    .nav-right .account-link:hover {
      color: white;
      border-color: white;
    }

    /* SIDEBAR */
    .sidebar-container {
      position: fixed;
      top: 60px;
      left: 0;
      width: 200px;
      background-color: white;
      bottom: 0;
      border-right: 1px solid #ddd;
      padding: 20px 0;
      display: flex;
      flex-direction: column;
      gap: 5px;
      overflow-y: hidden;
      z-index: 900;
    }

    .sidebar-link {
      display: block;
      padding: 12px 20px;
      color: #022d6d;
      text-decoration: none;
      font-size: 14px;
      transition: all 0.3s;
    }

    .sidebar-link:hover,
    .sidebar-link.active {
      background-color: #022d6d;
      color: white;
      border-radius: 4px;
      margin: 0 10px;
    }

    .btn-logout {
      background-color: #f30000;
      color: white;
      border: none;
      width: 80%;
      padding: 10px;
      margin: auto 10% 20px;
      border-radius: 3px;
      cursor: pointer;
      align-self: center;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    .btn-logout:hover {
      background-color: #d00000;
    }

    /* MAIN CONTENT */
    .content-wrapper {
      margin-left: 210px;
      margin-top: 80px;
      padding: 30px;
      flex: 1;
      overflow-y: auto;
    }

    h2 {
      color: #f36b00;
      font-weight: normal;
      margin-bottom: 20px;
      font-size: 24px;
    }

    /* DASHBOARD CARDS */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .stats-card {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
      transition: transform 0.2s;
    }

    .stats-card:hover {
      transform: translateY(-3px);
    }

    .stats-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stats-value {
      font-size: 32px;
      color: #022d6d;
      font-weight: bold;
    }

    /* LAYOUT: CALENDAR & UPCOMING */
    .dashboard-lower {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      align-items: start;
    }

    .calendar-box {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 20px;
      height: 650px;
      display: flex;
      flex-direction: column;
    }

    .calendar-title {
      color: #022d6d;
      margin-bottom: 15px;
      font-size: 18px;
      border-bottom: 2px solid #f36b00;
      padding-bottom: 10px;
    }

    #calendar {
      flex-grow: 1;
    }

    /* FullCalendar Customization */
    .fc-toolbar-title {
      font-size: 1.2em !important;
      color: #022d6d;
    }
    
    .fc-button-primary {
      background-color: #022d6d !important;
      border-color: #022d6d !important;
    }

    .upcoming-box {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 20px;
      height: fit-content;
      max-height: 650px;
      overflow-y: auto;
    }

    .upcoming-title {
      color: #022d6d;
      margin-bottom: 15px;
      font-size: 18px;
      border-bottom: 2px solid #f36b00;
      padding-bottom: 10px;
    }

    .event-item {
      background-color: #f8f9fa;
      border-left: 4px solid #022d6d;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: all 0.2s;
    }

    .event-item:hover {
      transform: translateX(3px);
      background-color: #e9ecef;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .event-item h4 {
      font-size: 15px;
      color: #022d6d;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .event-item p {
      font-size: 13px;
      color: #666;
      margin-bottom: 5px;
    }

    .status-badge {
      display: inline-block;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 12px;
      font-weight: bold;
      background-color: #e3f2fd;
      color: #022d6d;
    }
    
    .no-upcoming-text {
      color: #888;
      font-style: italic;
      text-align: center;
      padding: 20px;
      font-size: 14px;
    }

    /* FOOTER */
    footer {
      background-color: #242424;
      color: #f36b00;
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      padding: 40px 80px;
      flex-wrap: wrap;
      margin-top: auto;
    }

    .footer-group {
      max-width: 400px;
      margin-left: 80px;
    }

    .footer-title {
      color: #f36b00;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .footer-text {
      color: white;
      font-size: 14px;
      line-height: 1.6;
    }

    .footer-link {
      color: white;
      text-decoration: underline;
      font-size: 14px;
    }

    .footer-link:hover {
      color: #f36b00;
    }

    /* CUSTOM ALERT OVERLAY */
    .custom-alert-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }

    .custom-alert-overlay.show {
      display: flex;
    }

    .custom-alert-box {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      width: 400px;
      max-width: 90%;
      overflow: hidden;
      animation: alertSlideDown 0.3s ease;
    }

    @keyframes alertSlideDown {
      from { opacity: 0; transform: translateY(-50px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .custom-alert-header {
      background: linear-gradient(135deg, #022d6d 0%, #034a9e 100%);
      color: white;
      padding: 15px 20px;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .custom-alert-icon {
      font-size: 20px;
    }

    .custom-alert-body {
      padding: 25px 20px;
      color: #333;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-line;
    }

    .custom-alert-footer {
      padding: 15px 20px;
      text-align: right;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      background-color: #f9f9f9;
    }

    .custom-alert-btn {
      background-color: #022d6d;
      color: white;
      border: none;
      padding: 8px 25px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: 0.3s;
    }

    .custom-alert-btn:hover {
      background-color: #00328f;
    }

    .custom-alert-btn-cancel {
      background-color: #757575;
      color: white;
      border: none;
      padding: 8px 25px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: 0.3s;
    }

    .custom-alert-btn-cancel:hover {
      background-color: #5a5a5a;
    }

    /* RESPONSIVE */
    @media (max-width: 1024px) {
      .dashboard-lower {
        grid-template-columns: 1fr;
      }
      .stats-container {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .content-wrapper {
        margin-left: 0;
        padding: 20px;
      }
      .sidebar-container {
        display: none;
      }
      .stats-container {
        grid-template-columns: 1fr;
      }
      footer {
        padding: 30px 20px;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      .footer-group {
        margin-left: 0;
        margin-bottom: 20px;
      }
    }
  </style>
</head>

<body>

  <!-- CUSTOM ALERT MODAL -->
  <div class="custom-alert-overlay" id="customAlertOverlay">
    <div class="custom-alert-box">
      <div class="custom-alert-header">
        <span class="custom-alert-icon" id="customAlertIcon">‚ÑπÔ∏è</span>
        <span id="customAlertTitle">Message</span>
      </div>
      <div class="custom-alert-body" id="customAlertBody">
        Alert message here
      </div>
      <div class="custom-alert-footer" id="customAlertFooter">
        <button class="custom-alert-btn" id="customAlertBtn">OK</button>
      </div>
    </div>
  </div>

  <!-- NAVIGATION BAR -->
  <nav>
    <div class="nav-left">
      <img src="../../images/UMAK LOGO.png" alt="UMak Logo">
      <span>University of Makati - ECP</span>
    </div>
    <div class="nav-right">
      <a href="student_account.html" class="account-link">‚öôÔ∏è Settings</a>
    </div>
  </nav>

  <!-- SIDEBAR -->
  <div class="sidebar-container">
    <a href="#" class="sidebar-link active">Dashboard</a>
    <a href="student_events.html" class="sidebar-link">Events</a>
    <a href="student_venues.html" class="sidebar-link">Venues</a>
    <a href="student_post_eval.html" class="sidebar-link">Post-Evaluation</a>
    <a href="student_my_events.html" class="sidebar-link">My Events</a>
    <a href="student_messages.html" class="sidebar-link">Messages</a>
    <button class="btn-logout" id="logoutBtn" onclick="logout()">Logout</button>
  </div>

  <!-- MAIN CONTENT -->
  <div class="content-wrapper">
    <h2 id="textGreeting">Hi, Student!</h2>

    <!-- DASHBOARD CARDS -->
    <div class="stats-container" id="statsContainer">
        <div class="stats-card">
            <h3>Registered Events</h3>
            <p class="stats-value" id="statRegistered">0</p>
        </div>
        <div class="stats-card">
            <h3>Available Events</h3>
            <p class="stats-value" id="statAvailable">0</p>
        </div>
        <div class="stats-card">
            <h3>Events Attended</h3>
            <p class="stats-value" id="statAttended">0</p>
        </div>
        <div class="stats-card">
            <h3>Pending Evaluations</h3>
            <p class="stats-value" id="statEvals" style="color:#dc3545;">0</p>
        </div>
    </div>

    <!-- CALENDAR + UPCOMING EVENTS -->
    <div class="dashboard-lower">
      <div class="calendar-box">
        <h4 class="calendar-title">Event Calendar</h4>
        <!-- FullCalendar will be injected here -->
        <div id="calendar"></div>
      </div>

      <div class="upcoming-box">
        <h4 class="upcoming-title">Upcoming Events</h4>
        <div id="upcomingList">
            <p class="no-upcoming-text">Loading events...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    <div class="footer-group">
      <h4 class="footer-title">About ECP</h4>
      <p class="footer-text">
        The Event Coordination Portal serves as the central management system for events
        organized by the colleges of the University of Makati. It oversees event operations,
        tracks student participation, and maintains an updated event calendar.
      </p>
    </div>
    <div class="footer-group">
      <h4 class="footer-title">Links</h4>
      <a href="https://www.umak.edu.ph/" target="_blank" class="footer-link">University of Makati</a>
    </div>
  </footer>

  <!-- FullCalendar Scripts -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>

  <script>
    // API Configuration
    const API_BASE = '../../api';
    let currentStudentId = null;
    let currentStudentNumber = null;
    
    // Check Session
    const session = JSON.parse(localStorage.getItem('user_session'));
    if (!session || session.user_type !== 'student') {
        window.location.href = '../login_signup.html';
    } else {
        currentStudentId = session.user_id;
        document.getElementById('textGreeting').textContent = `Hi, ${session.firstname.toUpperCase()}! üëã`;
    }

    // Custom Alert Function
    function customAlert(message, type = 'info', callback) {
      const overlay = document.getElementById('customAlertOverlay');
      const icon = document.getElementById('customAlertIcon');
      const title = document.getElementById('customAlertTitle');
      const body = document.getElementById('customAlertBody');
      const footer = document.getElementById('customAlertFooter');

      // Icons and Titles
      if (type === 'success') {
        icon.textContent = '‚úÖ'; title.textContent = 'Success';
      } else if (type === 'error') {
        icon.textContent = '‚ùå'; title.textContent = 'Error';
      } else if (type === 'confirm') {
        icon.textContent = '‚ùì'; title.textContent = 'Confirm Action';
      } else {
        icon.textContent = '‚ÑπÔ∏è'; title.textContent = 'Information';
      }

      body.innerHTML = message; // Use innerHTML to allow simple formatting like bold or breaks
      overlay.classList.add('show');

      if (type === 'confirm') {
          footer.innerHTML = `
            <button class="custom-alert-btn-cancel" id="btnCancel">Cancel</button>
            <button class="custom-alert-btn" id="btnOk">Confirm</button>
          `;
          document.getElementById('btnOk').onclick = () => { overlay.classList.remove('show'); if(callback) callback(true); };
          document.getElementById('btnCancel').onclick = () => { overlay.classList.remove('show'); if(callback) callback(false); };
      } else {
          footer.innerHTML = `<button class="custom-alert-btn" onclick="document.getElementById('customAlertOverlay').classList.remove('show')">OK</button>`;
      }
    }

    // Load Dashboard Data
    async function loadDashboardData() {
      if (!currentStudentId) return;
      
      try {
        const response = await fetch(`${API_BASE}/student_dashboard.php?student_id=${currentStudentId}`);
        const result = await response.json();
        
        if (result.success) {
          // 1. Update Stats
          document.getElementById('statRegistered').textContent = result.stats.registered_events;
          document.getElementById('statAvailable').textContent = result.stats.available_events;
          document.getElementById('statAttended').textContent = result.stats.attended_events;
          document.getElementById('statEvals').textContent = result.stats.pending_evaluation;

          // 2. Update Upcoming List
          const list = document.getElementById('upcomingList');
          list.innerHTML = '';
          
          if (result.upcoming_events.length === 0) {
            list.innerHTML = '<p class="no-upcoming-text">No upcoming events found for your college.</p>';
          } else {
            result.upcoming_events.forEach(ev => {
                const div = document.createElement('div');
                div.className = 'event-item';
                div.innerHTML = `
                    <h4>${ev.event_name}</h4>
                    <p>${new Date(ev.event_date).toDateString()}</p>
                    <p>${ev.venue_name}</p>
                    <span class="status-badge">${ev.registration_status}</span>
                `;
                // Clicking redirects to events page
                div.onclick = () => window.location.href = "student_events.html"; 
                list.appendChild(div);
            });
          }

          // 3. Initialize Calendar with Data
          initFullCalendar(result.calendar_events);
          
        } else {
          console.error('API Error:', result.message);
          customAlert("Failed to load dashboard data.", "error");
        }
      } catch (error) {
        console.error('Fetch Error:', error);
      }
    }

    // Initialize FullCalendar
    function initFullCalendar(events) {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: '100%',
            headerToolbar: { 
                left: 'prev,next today', 
                center: 'title', 
                right: 'dayGridMonth,listWeek' 
            },
            events: events,
            eventClick: function(info) {
                const ev = info.event;
                // Note: Our API sends color green (#28a745) for registered events
                const isRegistered = ev.backgroundColor === '#28a745';
                const statusText = isRegistered ? "‚úÖ Registered" : "‚ÑπÔ∏è Open for Registration";
                
                // Format time cleanly
                const startTime = ev.start ? ev.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                const endTime = ev.end ? ev.end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                
                // Create a nice detailed message for the custom alert
                const details = `
                    <strong>${ev.title.replace('‚úì ', '')}</strong><br><br>
                    Date: ${ev.start.toDateString()}<br>
                    Time: ${startTime} - ${endTime}<br>
                    Status: ${statusText}
                `;
                
                customAlert(details);
            }
        });
        calendar.render();
    }

    // Logout function
    function logout() {
      customAlert("Are you sure you want to logout?", 'confirm', (confirmed) => {
        if (confirmed) {
          localStorage.removeItem('user_session');
          window.location.href = '../login_signup.html';
        }
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      loadDashboardData();
    });
  </script>
</body>
</html>