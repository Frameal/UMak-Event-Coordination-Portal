<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>University of Makati - ECP Admin Dashboard</title>
  <style>
    /* --- CSS FROM admin_dashboard.css --- */
    
    /* UNIVERSAL STYLES */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Century Gothic', sans-serif;
    }

    body {
      background-color: #f4f5f7;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* NAVIGATION BAR */
    nav {
      background-color: #022d6d;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 40px;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .navbar-left {
      display: flex;
      align-items: center;
      gap: 15px;
      color: white;
      font-size: 16px;
      font-weight: normal;
    }

    .navbar-left img {
      height: 40px;
    }

    .navbar-links {
      list-style: none;
      display: flex;
      gap: 25px;
      align-items: center;
    }

    .navbar-links li a {
      text-decoration: none;
      color: white;
      padding: 10px 20px;
      border-radius: 3px;
      transition: 0.3s;
    }

    .navbar-links li a:hover,
    .navbar-links li a.active-link {
      background-color: #f36b00;
      color: white;
    }

    /* NAV RIGHT - Settings & Logout */
    .nav-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .nav-right .account-link {
      color: #ccc;
      font-size: 12px;
      text-decoration: none;
      border: 1px solid #ccc;
      padding: 5px 10px;
      border-radius: 15px;
      transition: 0.3s;
    }

    .nav-right .account-link:hover {
      color: white;
      border-color: white;
    }

    /* LOGOUT BUTTON */
    .logout-btn {
      background-color: #f30000;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 25px;
      cursor: pointer;
      transition: 0.3s;
    }

    .logout-btn:hover {
      background-color: #d00000;
      transform: scale(1.05);
    }

    /* MAIN CONTENT */
    main {
      flex: 1;
      padding: 40px 60px;
    }

    .dashboard-greeting {
      font-size: 22px;
      color: #f36b00;
      margin-bottom: 20px;
    }

    /* DASHBOARD WRAPPER */
    .dashboard-wrapper {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 25px 30px;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }

    .dashboard-title {
      color: #f36b00;
      font-weight: bold;
    }

    .dashboard-actions {
      display: flex;
      gap: 10px;
    }

    .dashboard-actions button {
      background-color: #022d6d;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.3s, transform 0.1s;
    }

    .dashboard-actions button:hover {
      background-color: #f36b00;
      transform: scale(1.05);
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
    }

    .dashboard-card {
      background-color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 25px;
      border-radius: 6px;
      text-align: center;
      transition: transform 0.2s;
    }

    .dashboard-card:hover {
        transform: translateY(-5px);
    }

    .dashboard-card h3 {
      font-size: 14px;
      color: #022d6d;
      margin-bottom: 15px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .dashboard-card p {
      font-size: 32px;
      font-weight: bold;
      color: #022d6d;
    }

    /* ALERTS */
    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border: 1px solid transparent;
        border-radius: 4px;
    }
    .alert-error {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }

    /* MODAL STYLES */
    .modal {
        display: none; 
        position: fixed; 
        z-index: 2000; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.5); 
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background-color: #fefefe;
        padding: 20px;
        border: 1px solid #888;
        width: 600px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .modal-header h3 {
        color: #022d6d;
        margin: 0;
    }

    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover,
    .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .approval-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 15px;
    }

    .approval-table th, .approval-table td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        font-size: 14px;
    }

    .approval-table th {
        background-color: #f8f9fa;
        color: #022d6d;
    }

    .btn-approve {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        margin-right: 5px;
    }

    .btn-reject {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
    }

    .empty-message {
        text-align: center;
        padding: 20px;
        color: #666;
        font-style: italic;
    }

    /* FOOTER */
    footer {
      background-color: #242424;
      color: #f36b00;
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      padding: 40px 20px;
      flex-wrap: wrap;
      margin-top: auto;
    }

    .footer-column {
      max-width: 400px;
    }

    .footer-column h4 {
      margin-bottom: 10px;
      color: #f36b00;
    }

    .footer-column p,
    .footer-column a {
      color: white;
      font-size: 14px;
      line-height: 1.6;
      text-decoration: none;
    }

    .footer-column a:hover {
      color: #f36b00;
      text-decoration: underline;
    }

    /* RESPONSIVE */
    @media (max-width: 900px) {
      nav {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .navbar-links {
        flex-wrap: wrap;
        justify-content: flex-start;
        width: 100%;
        gap: 10px;
      }

      .navbar-links li a {
        padding: 10px 15px;
      }

      main {
        padding: 20px;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
  </style>
</head>

<body>

  <nav>
    <div class="navbar-left">
      <img src="../../images/UMAK LOGO.png" alt="UMak Logo">
      <span>University of Makati - ECP</span>
    </div>

    <ul class="navbar-links">
      <li><a href="#" class="active-link">Dashboard</a></li>
      <li><a href="admin_students.html">Students</a></li>
      <li><a href="admin_events.html">Events & Booking</a></li>
      <li><a href="admin_venues.html">Venues</a></li>
      <li><a href="admin_post_evaluations.html">Post-Evaluation</a></li>
      <li><a href="admin_messages.html">Messages</a></li>
    </ul>

    <div class="nav-right">
      <a href="admin_account.html" class="account-link">‚öôÔ∏è Settings</a>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </nav>

  <main>
    <div class="dashboard-greeting"><b>Hello, <span id="lblUsername">Admin</span>!</b> üëã</div>

    <div class="dashboard-wrapper">
      <div id="alertContainer"></div>

      <div class="dashboard-header">
        <h2 class="dashboard-title">System Dashboard</h2>
        <div class="dashboard-actions">
          <button id="btnApproveAdmin" onclick="openApprovalModal('admin')">Approve Admin Accounts</button>
          <button id="btnApproveOrg" onclick="openApprovalModal('org')" style="display:none;">Approve Organization Accounts</button>
        </div>
      </div>

      <div class="dashboard-grid" id="dashboardStatsContainer">
         <p>Loading dashboard statistics...</p>
      </div>
    </div>
  </main>

  <!-- Approval Modal -->
  <div id="approvalModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="approvalModalTitle">Pending Approvals</h3>
            <span class="close" onclick="closeApprovalModal()">&times;</span>
        </div>
        <div id="approvalListContainer">
            <!-- Table will be injected here -->
        </div>
    </div>
  </div>

  <footer>
    <div class="footer-column about-ecp">
      <h4>About ECP</h4>
      <p>
        The Event Coordination Portal serves as the central management system for events
        organized by the colleges of the University of Makati. It oversees event operations,
        tracks student participation, and maintains an updated event calendar.
      </p>
    </div>

    <div class="footer-column quick-links">
      <h4>Links</h4>
      <a href="https://www.umak.edu.ph/" target="_blank">University of Makati</a>
    </div>
  </footer>

  <script>
    /* --- CONSOLIDATED JS Logic (Utility + Dashboard) --- */

    // Configuration: Pointing to the API folder relative to this file
    const API_BASE = '../../api'; 
    let currentAdminDept = '';

    // --- UTILITY FUNCTIONS ---
    
    // API Call Handler
    async function apiCall(endpoint, method = 'GET', data = null) {
        const options = {
            method,
            headers: { 'Content-Type': 'application/json' }
        };
        
        if (data && method !== 'GET') options.body = JSON.stringify(data);
        
        try {
            const response = await fetch(`${API_BASE}/${endpoint}`, options);
            const text = await response.text();
            
            try {
                return JSON.parse(text); // Try to parse JSON
            } catch (e) {
                console.error("Server Response (Not JSON):", text);
                throw new Error("Invalid server response");
            }
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }

    // Alert Display
    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        
        const container = document.getElementById('alertContainer');
        if (container) {
            container.innerHTML = ''; // Clear previous
            container.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        } else {
            alert(message);
        }
    }

    // --- DASHBOARD LOGIC ---

    // Check Session and Display Username
    function checkSession() {
        const userSession = localStorage.getItem('user_session');
        if (!userSession) {
            window.location.href = '../login_signup.html';
            return;
        }

        const user = JSON.parse(userSession);
        if (user.user_type !== 'admin') {
            alert('Access Denied: Admins only.');
            window.location.href = '../login_signup.html';
            return;
        }

        const usernameEl = document.getElementById('lblUsername');
        if (usernameEl) {
            usernameEl.textContent = (user.firstname + ' ' + user.lastname).toUpperCase();
        }

        currentAdminDept = user.department;

        // Show Org Approval button ONLY for CSOA admins
        if (currentAdminDept === 'CSOA') {
            document.getElementById('btnApproveOrg').style.display = 'block';
        }
    }

    // Load Stats from API
    async function loadDashboard() {
        const container = document.getElementById('dashboardStatsContainer');
        
        try {
            const response = await apiCall('admin_dashboard.php'); 
            
            if (response.success) {
                renderDashboardCards(response.data);
            } else {
                container.innerHTML = `<p style="color:red">Error: ${response.message}</p>`;
            }

        } catch (error) {
            console.error('Error loading dashboard:', error);
            container.innerHTML = `
                <div style="grid-column: 1/-1; text-align: center; padding: 20px;">
                    <p style="color: #721c24; margin-bottom: 10px;">
                        Failed to connect to database. Please ensure XAMPP is running.
                    </p>
                    <button onclick="loadDashboard()" style="padding:5px 10px; cursor:pointer;">Retry</button>
                </div>`;
        }
    }

    function renderDashboardCards(stats) {
        const container = document.getElementById('dashboardStatsContainer');
        if (!container) return;
        
        const cards = [
            { title: 'TOTAL STUDENTS', value: stats.total_students || 0 },
            { title: 'TOTAL VENUES', value: stats.total_venues || 0 },
            { title: 'TOTAL EVENTS', value: stats.total_events || 0 },
            { title: 'TOTAL REGISTRATIONS', value: stats.total_registrations || 0 },
            { title: 'UPCOMING EVENTS', value: stats.upcoming_events || 0 }
        ];
        
        container.innerHTML = cards.map(card => `
            <div class="dashboard-card">
                <h3>${card.title}</h3>
                <p>${card.value}</p>
            </div>
        `).join('');
    }

    // --- APPROVAL LOGIC ---

    function openApprovalModal(type) {
        const modal = document.getElementById('approvalModal');
        const title = document.getElementById('approvalModalTitle');
        const container = document.getElementById('approvalListContainer');
        
        modal.style.display = 'flex';
        container.innerHTML = '<p class="empty-message">Loading...</p>';

        if (type === 'admin') {
            title.textContent = `Pending Admin Accounts (${currentAdminDept})`;
            fetchPendingAdmins();
        } else {
            title.textContent = 'Pending Organization Accounts';
            fetchPendingOrgs();
        }
    }

    function closeApprovalModal() {
        document.getElementById('approvalModal').style.display = 'none';
    }

    async function fetchPendingAdmins() {
        try {
            // Pass current department to filter only relevant admins
            const response = await apiCall(`admin_approvals.php?type=admin&dept=${currentAdminDept}`);
            renderApprovalTable(response, 'admin');
        } catch (e) {
            document.getElementById('approvalListContainer').innerHTML = '<p class="empty-message">Error loading data.</p>';
        }
    }

    async function fetchPendingOrgs() {
        try {
            const response = await apiCall('admin_approvals.php?type=org');
            renderApprovalTable(response, 'org');
        } catch (e) {
            document.getElementById('approvalListContainer').innerHTML = '<p class="empty-message">Error loading data.</p>';
        }
    }

    function renderApprovalTable(data, type) {
        const container = document.getElementById('approvalListContainer');
        
        if (!data || data.length === 0) {
            container.innerHTML = '<p class="empty-message">No pending approvals found.</p>';
            return;
        }

        let html = `<table class="approval-table">
                      <thead>
                        <tr>
                            <th>Name</th>
                            <th>${type === 'admin' ? 'Employee ID' : 'College'}</th>
                            <th>Email</th>
                            <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>`;
        
        data.forEach(item => {
            const id = type === 'admin' ? item.admin_id : item.org_id;
            const name = type === 'admin' ? `${item.lastname}, ${item.firstname}` : item.org_name;
            const info = type === 'admin' ? item.employee_number : item.college;
            const email = type === 'admin' ? item.email : item.org_email;

            html += `<tr>
                        <td>${name}</td>
                        <td>${info}</td>
                        <td>${email}</td>
                        <td>
                            <button class="btn-approve" onclick="processApproval('${type}', ${id}, 'Approved')">Approve</button>
                            <button class="btn-reject" onclick="processApproval('${type}', ${id}, 'Rejected')">Reject</button>
                        </td>
                     </tr>`;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    async function processApproval(type, id, status) {
        if(!confirm(`Are you sure you want to ${status.toLowerCase()} this account?`)) return;

        try {
            const response = await apiCall('admin_approvals.php', 'POST', {
                type: type,
                id: id,
                status: status
            });

            if (response.success) {
                alert(`Account ${status} successfully!`);
                if (type === 'admin') fetchPendingAdmins();
                else fetchPendingOrgs();
            } else {
                alert("Error: " + response.message);
            }
        } catch (e) {
            alert("Connection error.");
        }
    }

    // Logout Function
    function logout() {
        const confirmLogout = confirm("Are you sure you want to logout?");
        if (confirmLogout) {
            localStorage.removeItem('user_session');
            window.location.href = "../login_signup.html";
        }
    }

    // Initialize Page
    document.addEventListener('DOMContentLoaded', () => {
        checkSession();
        loadDashboard();
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('approvalModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

  </script>
</body>
</html>